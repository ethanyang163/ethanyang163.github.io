<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.5"/><style data-href="/styles.d6e3fe2d414a2aca125b.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.layout-module--container--78b04{font-family:sans-serif;margin:auto;max-width:500px}.layout-module--heading--f158c{color:#639}.layout-module--nav-links--1113b{display:flex;list-style:none;padding-left:0}.layout-module--nav-link-item--a5f0a{padding-right:2rem}.layout-module--nav-link-text--69cda{color:#000}.layout-module--site-title--e4dea{color:gray;font-size:3rem;font-weight:700;margin:3rem 0}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-gatsby-head="true">如何实现一个webpack loader | Ethan Yang</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--78b04"><header class="layout-module--site-title--e4dea">Ethan Yang</header><nav><ul class="layout-module--nav-links--1113b"><li class="layout-module--nav-link-item--a5f0a"><a class="layout-module--nav-link-text--69cda" href="/">Home</a></li><li class="layout-module--nav-link-item--a5f0a"><a class="layout-module--nav-link-text--69cda" href="/about/">About</a></li><li class="layout-module--nav-link-item--a5f0a"><a class="layout-module--nav-link-text--69cda" href="/blog/">Blog</a></li></ul></nav><main><h1 class="layout-module--heading--f158c">如何实现一个webpack loader</h1><img src="https://redd.one/static/e9c12b1d95e9e01c05f752667efce5b3/426b8/thumbnail.jpg" alt="mp3"/>
<h2>介绍</h2>
<blockquote>
<p>本文基于最新的 <strong>webpack v5</strong> 实现</p>
</blockquote>
<p><a href="https://webpack.js.org/" rel="nofollow noopener noreferrer">webpack</a> 正在为越来越多的现代前端工具（Create React App, NextJS, Gatsby）提供基础支撑。无论你使用哪一种工具，理解 如何自定义 webpack 配置都将使你受益。尽管 webpack 配置有时候并不是那么容易。</p>
<p>今天我要讨论的是：如何实现一个自定义的 webpack loader。这个主题没有太多的文档可供参考。本文也是基于常用的 loaders 进行逆向工程的结果。</p>
<h2>loader 基础</h2>
<p><a href="https://webpack.js.org/concepts/loaders/" rel="nofollow noopener noreferrer">webpack loader</a> 是转换导入模块源代码的函数。
例如：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> styles <span class="token operator">=</span> <span class="token function">cssLoader</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./styles.css"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></span>
<p>webpack 能够将 TypeScript 编译为 JavaScript、转换 SASS 为 CSS、将 JSX 转化为<span><code class="language-text">React.createElement</code></span>调用。其实这都是作为 webpack 核心的 loader 的作用。另一方面，webpack 创建了一个源码转化链来确保特定的 loader 在适当的时机被执行。</p>
<p>loader 在 webpack 中的配置如下：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// Capture all "*.js" imports,</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token comment">// ...and transform them via "babel-loader".</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// Capture all the "*.css" imports,</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span>
        <span class="token comment">// ...and transform them via "css-loader".</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div></span>
<p>在上面的配置中，所有导入的<span><code class="language-text">*.js</code></span>文件被交给<span><code class="language-text">babel-loader</code></span>处理，所有的<span><code class="language-text">*.css</code></span>文件被交给<span><code class="language-text">css-loader</code></span>处理。对于同一种类型的文件，你可以提供多个 loader 来处理，loader 的应用顺序是从右至左。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.ext$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"third-loader"</span><span class="token punctuation">,</span> <span class="token string">"second-loader"</span><span class="token punctuation">,</span> <span class="token string">"first-loader"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div></span>
<p>当你把 loader 看成函数，源代码作为参数时，从右至左更加符合直觉。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">third</span><span class="token punctuation">(</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token function">first</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></span>
<h2>loader 的一些限制</h2>
<p>loader 用于转换代码。与 plugin 不同的是，loader 不会影响编译流程，只是在编译的过程中转换导入的模块代码。</p>
<p>一般来说，除了转换代码以外的事情都可以通过 <a href="https://webpack.js.org/concepts/#plugins" rel="nofollow noopener noreferrer">plugin</a> 来完成。plugin 不应该对源代码做任改变，这也是 plugin 区分于 loader 最主要的特征。</p>
<p>loader 有以下一些使用场景：</p>
<ul>
<li>支持特定格式的文件导入（例如：<span><code class="language-text">*.graphql</code></span>或者<span><code class="language-text">*.prisma</code></span>）</li>
<li>为转换后的文件添加元数据（例如在<span><code class="language-text">*.mdx</code></span>文件中插入前言）</li>
<li>修改导入的文件（例如 CSS 样式自动添加前缀）</li>
</ul>
<h2>实现一个自定义 loader</h2>
<p>在本文中我们准备实现一个 MP3 loader，这个 loader 可以转换导入的<span><code class="language-text">*.mp3</code></span>文件为<a href="https://reactjs.org/" rel="nofollow noopener noreferrer">React</a>播放组件。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> AudioPlayer <span class="token keyword">from</span> <span class="token string">'./audio.mp3'</span>

<span class="token keyword">function</span> MyComponent <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>AudioPlayer <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></span>
<h2>函数声明</h2>
<p>loader 接收源代码作为输入，转化后的源代码作为输出。我们创建<span><code class="language-text">mp3-loader.js</code></span>文件并声明一个函数：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<p>目前为止， 你的 loader 会原样输出导入的 MP3 文件。</p>
<p>我们使用<span><code class="language-text">&lt;audio></code></span>标签来播放导入的音频文件。我们需要知道 MP3 文件在最终生成目录中的路径。将路径提供给<span><code class="language-text">&lt;audio></code></span>标签的<span><code class="language-text">src</code></span>属性使用。</p>
<p>在 loader 的上下文环境中，可以通过<span><code class="language-text">this.resourcePath</code></span>属性来获得导入文件的绝对路径。</p>
<p>例如，对于下面的导入：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> AudioPlayer <span class="token keyword">from</span> <span class="token string">"./audio.mp3"</span><span class="token punctuation">;</span></code></pre></div></span>
<p><span><code class="language-text">this.resourcePath</code></span>会包含<span><code class="language-text">./audio.mp3</code></span>文件的绝对路径。知道了这些，我们来生成一个同名的 MP3 文件。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// webpack exposes an absolute path to the imported module</span>
  <span class="token comment">// under the "this.resourcePath" property. Get the file name</span>
  <span class="token comment">// of the imported module. For example:</span>
  <span class="token comment">// "/User/admin/audio.mp3" (this.resourcePath) -> "audio.mp3".</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Next, create an asset info object.</span>
  <span class="token comment">// webpack uses this object when outputting the build's stats,</span>
  <span class="token comment">// so you could see info about the emitted asset.</span>
  <span class="token keyword">const</span> assetInfo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">sourceFilename</span><span class="token operator">:</span> filename <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// Finally, emit the imported audio file's "source"</span>
  <span class="token comment">// in the webpack's build directory using a built-in</span>
  <span class="token comment">// "emitFile" method.</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> assetInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// For now, return the mp3 binary as-is.</span>
  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p>你需要保持住 webpack 的上下文环境来获得<span><code class="language-text">this.resourcePath</code></span>和<span><code class="language-text">this.emitFile</code></span>。确保你的 laoder 不是一个箭头函数，使用箭头函数会让你无法获得 webpack 暴露给 loader 的属性和方法。</p>
</blockquote>
<p>现在音频文件会伴随着 JavaScript 包一起输出。我们继续下一个步骤：在 loader 中返回一个 React 组件。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> assetInfo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">sourceFilename</span><span class="token operator">:</span> filename <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> assetInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
import React from 'react'
export default function Player(props) {
  return &lt;audio controls src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" />
}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Mark the loader as raw so that the emitted audio binary</span>
<span class="token comment">// does not get processed in any way.</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p>转换后的代码需要的依赖需要内联在生成的字符串中。loader 导入的依赖无法被编译后的代码访问到。</p>
</blockquote>
<p>loader 函数的输入输出必须是字符串。这就是为啥在字符串中声明了一个 React 组件，包含了 React 的导入语句。现在当我们导入一个 MP3 文件，导入的不再是 MP3 文件本身，而是一个 React 组件。</p>
<p>太棒了！你现在实现了一个将 MP3 文件转化为音频播放组件的 webpack loader。现在我们将它添加到 webpack 配置中以使其能够应用到所有的<span><code class="language-text">*.mp3</code></span>文件。</p>
<h2>配置自定义 loader</h2>
<p>配置 loader 有两种方式：让 webpack 从本地文件加载或者将 loader 发布成一个常规的依赖。除非你的 loader 足够通用，或者它需要被多个项目使用，否则我强烈建议你从本地文件加载来使用 loader。</p>
<h3>从本地文件加载 loader</h3>
<p>在 webpack 配置的<span><code class="language-text">resolveLoader</code></span>属性中给 loader 一个别名。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.mp3$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token comment">// Reference the loader by the same name</span>
        <span class="token comment">// that you aliased in "resolveLoader.alias" below.</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"babel-loader"</span><span class="token punctuation">,</span> <span class="token string">"mp3-loader"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">resolveLoader</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"mp3-loader"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/mp3-loader.js"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p>因为我们从 mp3-loader 中返回了 JSX，我们需要告诉 webpack 将 JSX 转化为常规的 JavaScript。这就是我们为什么需要在<span><code class="language-text">mp3-loader</code></span>之后引入<span><code class="language-text">babel-loader</code></span>。（记住 loader 是从右往左执行）。</p>
</blockquote>
<h3>安装依赖加载 loader</h3>
<p>当你发布了一个 loader 到 NPM，你可以像使用其他的 Node.js 依赖一样来使用它。</p>
<blockquote>
<p>loader 的默认命名规则是<span><code class="language-text">[name]-loader</code></span>。当你需要发布一个 loader 时，记得这一点。</p>
</blockquote>
<p>当你发布 <span><code class="language-text">mp3-loader</code></span>到 NPM 之后，你就可以在项目中使用它了。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">npm install mp3<span class="token operator">-</span>loader</code></pre></div></span>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.mp3$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"babel-loader"</span><span class="token punctuation">,</span> <span class="token string">"mp3-loader"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p>你不需要手动导入你的 loader，webpack 能够自动在<span><code class="language-text">node_modules</code></span>中找到它。</p>
</blockquote>
<h2>使用你的 loader</h2>
<p>为了看到<span><code class="language-text">mp3-loader</code></span>的实际效果，运行<span><code class="language-text">webpack</code></span>CLI 命令来执行<span><code class="language-text">webpack.config.js</code></span>中的配置。</p>
<span><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ npx webpack
asset audio.mp3 2.38 MiB [compared for emit] [from: src/audio.mp3] (auxiliary name: main)
asset main.js 858 KiB [compared for emit] (name: main)
webpack 5.37.0 compiled successfully in 1347 ms</code></pre></div></span>
<blockquote>
<p><span><code class="language-text">mp3-loader</code></span>的最终代码在这里：<a href="https://github.com/Redd-Developer/webpack-custom-loader" rel="nofollow noopener noreferrer">Redd-Developer/webpack-custom-loader</a></p>
</blockquote>
<h2>测试你的 loader</h2>
<p>既然 loader 依赖于编译时上下文，我推荐在 webpack 编译时进行集成测试。测试用例的期望输出取决于 loader 的实现。</p>
<p>对于<span><code class="language-text">mp3-loader</code></span>我们有两点期望：、</p>
<ul>
<li>编译生成的资源中必须包含导入的 MP3 文件</li>
<li>编译生成的代码必须返回一个音频播放 React 组件</li>
</ul>
<p>我们将以上两点期望反映到测试代码中：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// test/mp3-loader.test.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createFsFromVolume<span class="token punctuation">,</span> Volume <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"memfs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// A custom wrapper to promisify webpack compilation.</span>
<span class="token keyword">function</span> <span class="token function">compileAsync</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resolvedError <span class="token operator">=</span> error <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token string">"errors-only"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>resolvedError<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'converts "*.mp3" import into an audio player'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Configure a webpack compiler.</span>
  <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.mp3$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"babel-loader"</span><span class="token punctuation">,</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"../src/mp3-loader.js"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"babel-loader"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Create an in-memory file system so that the build assets</span>
  <span class="token comment">// are not emitted to disk during test runs.</span>
  <span class="token keyword">const</span> memoryFs <span class="token operator">=</span> <span class="token function">createFsFromVolume</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Volume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> memoryFs<span class="token punctuation">;</span>
  <span class="token comment">// Compile the bundle.</span>
  <span class="token keyword">await</span> <span class="token function">compileAsync</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Expect the imported audio file to be emitted alongside the build.</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">"dist/audio.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Expect the compiled code to create an "audio" element in React.</span>
  <span class="token keyword">const</span> compiledCode <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>
    <span class="token string">"dist/index.js"</span><span class="token punctuation">,</span>
    <span class="token string">"utf8"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>compiledCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'.createElement(\\"audio\\"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></span>
<h2>webpack loader 组成</h2>
<h3>loader 选项</h3>
<p>loader 能接收选项来改变自身的行为。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.mp3$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"mp3-loader"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">maxSizeBytes</span><span class="token operator">:</span> <span class="token number">1000000</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<p>在上面的 webpack 配置中，我们自定义了一个<span><code class="language-text">maxSizeBytes</code></span>选项。<span><code class="language-text">options</code></span>选项可以通过<span><code class="language-text">this.getOptions()</code></span>获取到：</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>maxSizeBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...parametrize your loader's behavior.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<h3>验证选项</h3>
<p>验证选项是否合理是一个好的习惯，可以避免很多错误。
<span><code class="language-text">schema-utils</code></span>模块可以用来验证 loader 选项是否合理。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> validate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"schema-utils"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Describe your loader's options in a JSON Schema.</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">maxSizeBytes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Validate the options early in your loader.</span>
  <span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...the rest of your loader.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p><span><code class="language-text">schema</code></span>对象定义使用<a href="https://json-schema.org/" rel="nofollow noopener noreferrer">JSON Schema</a>格式.</p>
</blockquote>
<h3>日志</h3>
<p>我们来考虑下<span><code class="language-text">maxSizeBytes</code></span>选项，当导入的音频文件超出了最大限制时抛出一条警告。</p>
<span><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/mp3-loader.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> assetStats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>assetStats<span class="token punctuation">.</span>size <span class="token operator">></span> options<span class="token punctuation">.</span>maxSizeBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Imported MP3 file is too large!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div></span>
<blockquote>
<p>了解更多的 <a href="https://webpack.js.org/api/logging/" rel="nofollow noopener noreferrer">webpack 日志接口</a></p>
</blockquote>
<h3>上下文属性</h3>
<table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>this.resourcePath</td><td>导入文件的绝对路径</td></tr><tr><td>this.rootContext</td><td>编译<a href="https://webpack.js.org/configuration/entry-context/#context" rel="nofollow noopener noreferrer">上下文环境</a></td></tr></tbody></table>
<blockquote>
<p>你可以打印出 <span><code class="language-text">this</code></span> 来查看所有的属性</p>
</blockquote>
<h3>上下文方法</h3>
<table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>this.emitFile()</td><td>在最终的目标目录中生成一个文件</td></tr><tr><td>this.getLogger()</td><td>获取<a href="https://webpack.js.org/api/logging/" rel="nofollow noopener noreferrer">webpack 日志实例</a></td></tr><tr><td>this.emitWarning()</td><td>编译时生成一个警告</td></tr><tr><td>this.getOptions()</td><td>获取 loader 选项</td></tr></tbody></table>
<blockquote>
<p>你可以打印出 <span><code class="language-text">this</code></span> 来查看所有的方法</p>
</blockquote>
<h2>参考文献</h2>
<p>关于 webpack 定制化的文档并不是完善。当我在学习写 webpack loader 的时候，我参考了之前使用过的一些 loader 的实现。下面是一些你可以参考的 loader 列表：</p>
<ul>
<li><a href="https://webpack.js.org/loaders/" rel="nofollow noopener noreferrer">Featured webpack loaders</a></li>
<li><a href="https://github.com/webpack-contrib/file-loader/" rel="nofollow noopener noreferrer">file-loader</a></li>
<li><a href="https://github.com/webpack-contrib/css-loader" rel="nofollow noopener noreferrer">css-loader</a></li>
</ul>
<h1>本文译自<a href="https://redd.one/blog/writing-custom-webpack-loader" rel="nofollow noopener noreferrer">Writing A Custom Webpack Loader</a></h1></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/post-2022-12-10/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-c1d20f87362ce5a0dc53.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-8418e948c6af4847a834.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-1fcb0d27a1924476424a.js\"],\"component---src-pages-blog-index-js\":[\"/component---src-pages-blog-index-js-5e0caaf646d460e0db1d.js\"],\"component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2021-02-22-mdx\":[\"/component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2021-02-22-mdx-315a82b8acfe1bd6b698.js\"],\"component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2021-06-02-mdx\":[\"/component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2021-06-02-mdx-04522693818a5613a7e5.js\"],\"component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2022-12-10-mdx\":[\"/component---src-pages-blog-mdx-frontmatter-slug-js-content-file-path-blog-post-2022-12-10-mdx-9cfa1c827bbf9c82ade2.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-70951c0a33aeccdbf5e8.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="11e46df3c0278a25d240";</script><script src="/webpack-runtime-b8ff2a3784688db68a5e.js" async></script><script src="/framework-00bf2bb98c1b8e9fbdeb.js" async></script><script src="/app-c1d20f87362ce5a0dc53.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>